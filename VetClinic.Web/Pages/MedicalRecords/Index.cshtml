@page
@model IndexModel
@{
    ViewData["Title"] = "Medical Records";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-file-medical text-success me-2"></i>Medical Records</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item active">Medical Records</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-8">
                            <label for="searchTerm" class="form-label">
                                <i class="fas fa-search me-1"></i>Search Records
                            </label>
                            <input asp-for="SearchTerm" class="form-control"
                                   placeholder="Search by pet name, diagnosis, treatment..." />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                                <a href="/MedicalRecords" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted">
                        @Model.MedicalRecords.Count() record(s) found
                    </span>
                </div>
                <div>
                    @if (ViewSessionHelper.IsInRole(ViewContext.HttpContext.Session, "Doctor"))
                    {
                        <a href="/MedicalRecords/Create" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i>Add Medical Record
                        </a>
                    }
                    @if (ViewSessionHelper.IsInRole(ViewContext.HttpContext.Session, "Customer"))
                    {
                        <a href="/Pets" class="btn btn-outline-primary">
                            <i class="fas fa-paw me-1"></i>My Pets
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Records Table -->
    <div class="row">
        <div class="col-12">
            @if (Model.MedicalRecords.Any())
            {
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th><i class="fas fa-calendar me-1"></i>Date</th>
                                        <th><i class="fas fa-paw me-1"></i>Pet</th>
                                        <th><i class="fas fa-user me-1"></i>Owner</th>
                                        <th><i class="fas fa-user-md me-1"></i>Doctor</th>
                                        <th><i class="fas fa-stethoscope me-1"></i>Diagnosis</th>
                                        <th><i class="fas fa-pills me-1"></i>Treatment</th>
                                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var record in Model.MedicalRecords)
                                    {
                                        <tr>
                                            <td>
                                                <span class="fw-bold">@record.VisitDate.ToString("MMM dd, yyyy")</span><br />
                                                <small class="text-muted">@record.VisitDate.ToString("hh:mm tt")</small>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-paw text-primary me-2"></i>
                                                    <div>
                                                        <span class="fw-bold">@record.Pet?.Name</span><br />
                                                        <small class="text-muted">@record.Pet?.Species - @record.Pet?.Breed</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold">@record.Pet?.Owner?.FullName</span><br />
                                                <small class="text-muted">@record.Pet?.Owner?.Email</small>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-user-md text-success me-2"></i>
                                                    <span class="fw-bold">Dr. @record.Doctor?.FullName</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info text-wrap" style="max-width: 150px;">
                                                    @record.Diagnosis
                                                </span>
                                            </td>
                                            <td>
                                                <span class="text-wrap" style="max-width: 200px;">
                                                    @(record.TreatmentNotes?.Length > 50 ? record.TreatmentNotes.Substring(0, 50) + "..." : record.TreatmentNotes)
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="/MedicalRecords/Details/@record.Id" class="btn btn-sm btn-outline-primary" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    @if (ViewSessionHelper.IsInRole(ViewContext.HttpContext.Session, "Doctor"))
                                                    {
                                                        <a href="/MedicalRecords/Edit/@record.Id" class="btn btn-sm btn-outline-warning" title="Edit Record">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }
                                                    <a href="/Pets/Details/@record.PetId" class="btn btn-sm btn-outline-info" title="View Pet">
                                                        <i class="fas fa-paw"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-file-medical fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Medical Records Found</h5>
                        <p class="text-muted">
                            @if (!string.IsNullOrEmpty(Model.SearchTerm))
                            {
                                <span>No records match your search criteria.</span>
                            }
                            else
                            {
                                <span>No medical records have been created yet.</span>
                            }
                        </p>
                        @if (ViewSessionHelper.IsInRole(ViewBag.Session, "Doctor"))
                        {
                            <a href="/MedicalRecords/Create" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Create First Medical Record
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-submit search form on Enter key
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="SearchTerm"]');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.form.submit();
                    }
                });
            }
        });
    </script>
}
